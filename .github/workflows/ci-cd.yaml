name: SQL Lint and Pattern Check
on:
  push:
 
jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        # with:
        #   fetch-depth: 0
      # - name: Debug Path
      #   run: |
      #     pwd
      #     ls -la
      #     ls -la ./sqlfluff-plugin-iceberg

      - name: Set up Python & Install SQLFluff + Plugin
        run: |
          python -m pip install --upgrade pip
          pip install sqlfluff
          pip install -e ./sqlfluff-plugin-iceberg
          # # pip install -e ./sqlfluff-plugin-iceberg
          # cd sqlfluff-plugin-iceberg
          # pip install -e .
        # pip install --no-cache-dir git+https://github.com/VishalSinha1103/Sqlfluff-testing.git@main#egg=sqlfluff-plugin-iceberg&subdirectory=sqlfluff-plugin-iceberg

      # - name: Debug - List all files
      #   run: |
      #     echo "üìÅ Listing all files and folders..."
      #     tree -a

      - name: List all folders
        run: |
          ls -l
      - name: Debug - Verify SQL Files
        run: |
          echo "üìÅ Verifying SQL files in sqlfiles/"
          ls -l ${{ github.workspace }}/sqlfiles

      - name: Lint SQL files
        run: |
          echo "üìÑ Linting SQL files..."
          cd sql
          sqlfluff lint --dialect iceberg iceberg.sql
          # sqlfluff lint sql/ --dialect mysql

       # sqlfluff lint sql/ --dialect snowflake
        # sqlfluff lint sql/ --dialect snowflake_with_iceberg
          

      # - name: Search for environment patterns
      #   run: |
      #     if grep -rnw '.' -e '@dev@' -e '@test@' -e '@prod@'; then
      #       echo "‚ùå Environment pattern found. Failing the workflow."
      #       exit 1
      #     else
      #       echo "‚úÖ No environment patterns found."
      #     fi
